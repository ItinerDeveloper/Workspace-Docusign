# Itiner Workspace DocuSign SES Addon Installation Guide

## 1. Preparation

### 1.1 System Requirements
- Windows operating system  
- Internet Information Services (IIS)  
- HTTPS certificate  
- Installed Itiner Workspace application  

### 1.2 File System
The `DocusignIntegration` module **must be located in the same folder as the Itiner Workspace application**.  
Recommended structure:
D:\ItinerWorkspace\DocusignIntegration\


---

## 2. Installation Steps

### 2.1 Copy the DocuSign Integration Folder
1. Unzip the `ItinerWorkspaceService_DocusignIntegration_x.x.x.ZIP`.
2. Copy the `DocusignIntegration` folder to `D:\ItinerWorkspace\`.

---

## 3. DocuSign Integration Setup

### 3.1 Required Files
Ensure the following files exist in the `DocusignIntegration` folder:
- `runtimes` folder  
- `ConsentApproval.html` file  
- `.dll` files  
- `appsettings.json`  
- `Web.config`  

### 3.2 IIS Application Pool
1. Open IIS Manager.
2. Create a new application pool:
   - **Name**: `ItinerWorkspace_DocusignIntegration` (or custom)
   - **.NET CLR Version**: No Managed Code
   - **Managed Pipeline Mode**: Integrated

3. Open **Advanced Settings** of the newly created application pool and modify the following parameters:
   - **General / Start Mode**: `AlwaysRunning`
   - **Process Model / Identity**: Set to `NetworkService`
   - **Recycling / Regular Time Interval**: Set to `0` (disables automatic recycling)
   - **Idle Time-out**: Set to `0`
   
### 3.3 Add IIS Web Application - Website Configuration
Install the DocuSign Integration on the same site as Itiner Workspace (e.g., `Default Website`).

1. Open IIS Manager.
2. Add a new web application with the following settings:
   - **Alias**: `DocusignIntegration`
   - **Application Pool**: Select the previously created pool (e.g., `ItinerWorkspace_DocusignIntegration`)
   - **Physical Path**: `D:\ItinerWorkspace\DocusignIntegration`


---

## 4. DocuSign Platform Configuration

> These steps must be completed in your **DocuSign production account** before using the integration.

### 4.1 Requirements
- A DocuSign **production account** with an active **eSignature Business Pro** subscription.
- The **integration key** generated by the Itiner Workspace team must be promoted to your production account.  
  _Contact the Itiner Workspace team for assistance._
- If you plan to use **Advanced (AES)** or **Qualified (QES)** Electronic Signatures, ensure your DocuSign account has  the Enterprise Pro subscription, and has these features enabled. You can do this by checking if you have `Docusign ID Verification for EU Advanced` (AES) and/or `Docusign ID Verification for EU Advanced` available on you Docusign Admin/Identity verifications page.

### 4.2 Integration Configuration Steps



1. **Generate RSA Key Pair**  
   Create a public/private RSA key pair. Place the **private key** file (`private.key`) in the `DocusignIntegration` folder.

2. **Set Redirect URI**  
   Add the following URI to your DocuSign integration settings:
`https://yourdomain.com/workspace/docusignintegration/ConsentApproval.html`


3. **Create HMAC Connect Key**  
Navigate to: `Integrations > Connect > Connect Keys`  
- Generate a new **HMAC Connect Key**
- Save the **secret**, it will be used in the addon configuration

4. **Set Up Connect Configuration**  
In `Integrations > Connect`:
- **URL to publish**:  
  ```
  https://yourdomain.com/workspace/docusignintegration/import/docusign/envelopecompleted
  ```
- **Trigger Events**:  
  - Envelope signed/completed
- **Include Data**:  
  - Custom Fields  
  - Documents  
- **Security**:
  - Enable **HMAC security**
  - Use the previously created Connect Key

> ⚠️ **Important**: Ensure that your Workspace instance is hosted on an **X443 port** (or standard 443). Otherwise, the DocuSign callback will fail to reach the service.

---

## 5. Configuration

### 5.1 `appsettings.json`
Edit the `appsettings.json` file in the `DocusignIntegration` folder with the following structure:
> 💡 For reference, see the `docusign_ses_appsettings_sample.json` file located in the GitHub repository.

#### Host Configuration
```json
"Host": {
  "WebHostUrl": "https://addonhost/workspace/docusignintegration",
  "WSUrl": "http://workspacehost/workspace/api",
  "WsApiKey": "test", // API key generated for integration user
  "HealthCheckBaseUrl": "http://addonhost", // optional
  "CustomApiKey": "test",
  "PathBase": "/workspace/docusignintegration",
  "DebugMode": false,
  "DisableRequestLog": false,
  "DisableMetadata": true
  },
```

#### Docusign Configuration
```json
"DocuSign": {
"ClientId": "Integration Key assigned by DocuSign",
"AuthServer": "account.docusign.com",
"ImpersonatedUserID": "User ID of your DocuSign production account",
"PrivateKeyFile": "./private.key",
"QESIdVerificationConfigName": "DocuSign ID Verification for EU Qualified", // Only required if QES signature type is used"
"AESIdVerificationConfigName": "DocuSign ID Verification for EU Advanced with Liveness"  // Only required if AES signature type is used"
},
"Hmac": {
"Secret": "HMAC Connect Key secret from DocuSign" // This key must be used as a secret key for the Itiner Workspace Webhook Connection.
},
```

- **ClientId**: DocuSign Integration Key  
  The integration key assigned by DocuSign when you register your application. This is used to identify your app during authorization.

- **AuthServer**: Always set to `account.docusign.com`  
  This specifies the authorization server used in the OAuth 2.0 flow for production environments.

- **ImpersonatedUserID**: DocuSign user ID used for envelope sending  
  The unique user ID of the account that will be impersonated when sending documents for signing.

- **PrivateKeyFile**: Path to the private RSA key  
  This should point to the `.key` file that holds the private part of the RSA key pair you generated during DocuSign setup (e.g., `./private.key`).

- **IdVerificationConfigName**: Name of the identity verification process used for AES/QES signing envelopes
  This has to be the exact same name as it is on the Docusign Admin/Identity verifications page.
  
- **Hmac.Secret**: Secret from the HMAC Connect Key created in DocuSign  
  This secret is used to validate the authenticity of incoming callback requests from DocuSign’s Connect service.

#### Reference Filter Configuration
- **Purpose**: Controls which events the integration service processes based on the `Reference` value in the event.
- **Behavior**:
  - If the `Filter` list is **not empty**, the integration service will **only process events** that contain a reference included in the `Filter` list.
  - If the `Filter` list is **empty**, the service will process **all events**, regardless of their `Reference` value.
- **Usage**: Populate the `Filter` list with user-defined keys to restrict the scope of processed events.

```json
"Reference": {
  "Filter": ["Email"]
},
```

#### Logging (Serilog) Configuration
```json
"Logging": {
        "LogLevel": {
            "Default": "Information",
            "Microsoft": "Warning",
            "Microsoft.Hosting.Lifetime": "Information"
        }
    },
"Serilog": {
    "LevelSwitches": {
        "$controlSwitch": "Information"
    },
    "MinimumLevel": {
        "ControlledBy": "$controlSwitch",
        "Override": {
            "System": "Warning",
            "Microsoft": "Error",
            "ServiceStack.Host.Handlers": "Error"
        }
    },
    "Enrich": ["FromLogContext", "WithMachineName", "WithThreadId"],
    "Properties": {
        "Application": "DocuSignIntegration"
        ,"HostURL": "https://workspacehostdnsname.com"
    },

    // Seq 
    "WriteTo": [{
            "Name": "Seq",
            "Args": {
                "serverUrl": "http://global_seq:5341",
                "apiKey": "",
                "controlLevelSwitch": "$controlSwitch",
                "eventBodyLimitBytes": null
            }
        }
    ]
}
```


---

## 6. Consent Authorization

Before the service can send out envelopes on behalf of a DocuSign production account, user consent must be granted.

1. Open the following URL in a web browser:
   ```
   https://yourdomain.com/workspace/docusignintegration/consent
   ```
2. Log in with the DocuSign user credentials when prompted.
3. Approve the access consent request for the integration.

Once authorized, the integration will be permitted to send documents for signing in the name of the authenticated user.

---

## 7. Logging
By default, logs are sent to an SEQ server. You may configure file or database logging if needed.

---

## 8. Restart
After completing the setup, restart the application pool in IIS Manager to apply all changes.

---

## 9. Updating the DocuSign Integration
1. **Stop** the application pool in IIS Manager.
2. Replace the existing `DocusignIntegration` folder with the updated version.
3. If needed, update the `appsettings.json` file with any new or changed keys.
4. **Restart** the application pool to activate the updated configuration.

---

This guide details the installation and configuration process for the DocuSign SES Addon within the Itiner Workspace platform. For support, contact the Itiner Workspace development team or your system administrator.
